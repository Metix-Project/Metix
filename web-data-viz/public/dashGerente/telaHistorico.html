<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Métix Proteção Divina</title>
    <link rel="icon" href="../assets/imgs/logo.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.0.2"></script>

    <!-- scripts do Chart.js - 2022-1 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>


    <!--Script Gerador WordCloud -->
    <link rel="shortcut icon" href="../img/icoNumeEtiqueta.ico" type="image/x-icon">
    
    <script src="../js/scrypt.js"></script>
    <script src="../js/sessao.js"></script>
    <link rel="stylesheet" href="../css/dashboardBase.css">
    <link rel="stylesheet" href="../css/telaHistorico.css">

    <style>
        canvas {
            -moz-user-select: none;
            -webkit-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="profile">
                <img alt="Profile" id="profileImage">
                <h2 id="profileName">Usuário</h2>
                <h4 id="profilePosition">Cargo: Gerente</h4>
                <h4 id="profileBusiness">Banco</h4>
            </div>

            <div class="dashboardLinks">
                <h2>Dashboards</h2>
                <button>Monitoramento</button>
                <button>Alertas</button>
                <button onclick="window.location.href = 'telaHistorico.html'">Histórico</button>
                <button>Previsões</button>
                <button>Manutenção</button>
                <button onclick="limparSessao()">Sair</button>
            </div>
            <div class="logo">
                <img src="../assets/imgs/Logo1.png" alt="Metix Logo">
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <h1 id="bodyTitle">Histórico dos Dados do Servidor - MacAddress 10f60a853491</h1>
            <div class="graphics1">
                <div class="filtros">
                    <div class="filtro selects">
                        <span>Selecione o Servidor: </span>
                        <select id="selectServer" onchange="modificarServidor(document.getElementById('selectServer').value)">
                            <option>10f60a853491</option>
                            <option>e8fb1cd57ab6</option>
                            <option>d09466c9be45</option>
                            <option>c7d12465a943</option>
                        </select>
                    </div>
                    <div class="filtro selects">
                        <span>Selecione a Métrica: </span>
                        <select id="selectHardware" onchange="modificarComponente(document.getElementById('selectHardware').value)">
                            <option value="1">Uso do Processador</option>
                            <option value="2">Uso da Memória RAM</option>
                            <option value="3">Uso do Disco Rígido</option>
                            <option value="4">Latência</option>
                            <option value="5">Velocidade de Rede</option>
                        </select>
                    </div>
                    <div class="filtro" id="dualHandleSlider">
                        <input type="range" min="7" max="90" value="30">
                        <span class="rangeLegend">
                            Últimos
                            <input type="number" min="7" max="90" value="30" id="dayValue">
                            dias
                        </span>
                    </div>
                </div>
                <div class="metricas">
                    <div class="cards" id="cards">
                        <div class="card">
                            <span>Uso médio da CPU</span>
                            <span class="infoValue" id="initialValue">55%</span>
                        </div>
                        <div class="card">
                            <span>Limite Permitido</span>
                            <span class="infoValue" id="limitValue">85%</span>
                        </div>
                        <div class="card">
                            <span>Quantidade de Alertas</span>
                            <span class="infoValue" id="qtdAlertsValue">4</span>
                            <span onclick="alert('')" id="alertDetails">Ver detalhes</span>
                        </div>
                    </div>
                    <div class="dados">
                        <canvas id="historicoComponenteEscolhido"></canvas>
                        <div class="moreInfo">
                            <div class="warnings">
                                <div class="infoCard">
                                    <span class="title">Tempo Total Acima do Limite Indicado</span>
                                    <span class="cardValue" id="totalTimeValue">3h 45min 54s</span>
                                </div>
                                <div class="infoCard">
                                    <span class="title">Último Registro de Alerta do Componente</span>
                                    <span class="cardValue" id="alertTimeValue">13h24 17/11/2024</span>
                                </div>
                            </div>
                            <div class="infoCard">
                                <span class="title">Sugestão do Gemini</span>
                                <span class="cardValue" id="geminiText">Fazer Upgrade!</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>

</html>

<script>
    window.onload = validarSessao();

    function modificarServidor(macAddress){
        document.getElementById("bodyTitle").innerHTML = `Histórico dos Dados do Servidor - MacAddress ${macAddress}`;
    }

    function modificarComponente(componente){
        if(componente == 1) {
            document.getElementById("cards").innerHTML = `
                <div class="card">
                    <span>Uso médio do Processador</span>
                    <span class="infoValue" id="initialValue">55%</span>
                </div>
                <div class="card">
                    <span>Limite Permitido</span>
                    <span class="infoValue" id="limitValue">85%</span>
                </div>
                <div class="card">
                    <span>Quantidade de Alertas</span>
                    <span class="infoValue" id="qtdAlertsValue">4</span>
                    <span onclick="alert('')" id="alertDetails">Ver detalhes</span>
                </div>
            `;

            document.getElementById("alertTimeValue").style.borderColor = 'rgb(255, 218, 107)';
            document.getElementById("totalTimeValue").style.borderColor = 'rgb(255, 218, 107)';
            document.getElementById("geminiText").style.borderColor = 'rgb(255, 218, 107)';
            historicoComponenteEscolhidoChart.options.scales.y.max = 100;
            historicoComponenteEscolhidoChart.options.scales.y.title.text = "Percentual de Uso";
            historicoComponenteEscolhidoChart.update();

            atualizarGraficoLinha(valores1, maxValues1, 'rgba(255, 218, 107, 0.8)', 'rgba(255, 218, 107, 0.2)', "do Uso do Processador");
            document.getElementById("initialValue").innerHTML = `${mediaCpuUsagePerc}%`;
        }
        else if(componente == 2) {
            document.getElementById("cards").innerHTML = `
                <div class="card">
                    <span>Uso médio da Memória RAM</span>
                    <span class="infoValue" id="initialValue">11.2 GB</span>
                </div>
                <div class="card">
                    <span>Limite Permitido</span>
                    <span class="infoValue" id="limitValue">14.5 GB</span>
                </div>
                <div class="card">
                    <span>Total de Memória RAM</span>
                    <span class="infoValue" id="initialValue">15.8 GB</span>
                </div>
                <div class="card">
                    <span>Quantidade de Alertas</span>
                    <span class="infoValue" id="qtdAlertsValue">2</span>
                    <span onclick="alert('')" id="alertDetails">Ver detalhes</span>
                </div>
            `;

            document.getElementById("alertTimeValue").style.borderColor = 'rgb(192, 178, 160)';
            document.getElementById("totalTimeValue").style.borderColor = 'rgb(192, 178, 160)';
            document.getElementById("geminiText").style.borderColor = 'rgb(192, 178, 160)';
            historicoComponenteEscolhidoChart.options.scales.y.max = 100;
            historicoComponenteEscolhidoChart.options.scales.y.title.text = "Percentual de Uso";
            historicoComponenteEscolhidoChart.update();

            atualizarGraficoLinha(valores2, maxValues2, 'rgba(192, 178, 160, 0.8)', 'rgba(192, 178, 160, 0.2)', "do Uso da Memória RAM");
            document.getElementById("initialValue").innerHTML = `${mediaRamUsageValue} GB`;
        }
        else if(componente == 3) {
            document.getElementById("cards").innerHTML = `
                <div class="card">
                    <span>Média do Armazenamento</span>
                    <span class="infoValue" id="initialValue">678.2 GB</span>
                </div>
                <div class="card">
                    <span>Limite Permitido</span>
                    <span class="infoValue" id="limitValue">930 GB</span>
                </div>
                <div class="card">
                    <span>Armazenamento Total</span>
                    <span class="infoValue" id="initialValue">986.7 GB</span>
                </div>
                <div class="card">
                    <span>Quantidade de Alertas</span>
                    <span class="infoValue" id="qtdAlertsValue">0</span>
                    <span onclick="alert('')" id="alertDetails">Ver detalhes</span>
                </div>
            `;

            document.getElementById("alertTimeValue").style.borderColor = 'rgb(249, 146, 44)';
            document.getElementById("totalTimeValue").style.borderColor = 'rgb(249, 146, 44)';
            document.getElementById("geminiText").style.borderColor = 'rgb(249, 146, 44)';
            historicoComponenteEscolhidoChart.options.scales.y.max = 100;
            historicoComponenteEscolhidoChart.options.scales.y.title.text = "Percentual de Uso";
            historicoComponenteEscolhidoChart.update();

            atualizarGraficoLinha(valores3, maxValues3, 'rgba(249, 146, 44, 0.8)', 'rgba(249, 146, 44, 0.2)', "do Armazenamento");
            document.getElementById("initialValue").innerHTML = `${mediaDiskUsageValue} GB`;
        }
        else if(componente == 4) {
            document.getElementById("cards").innerHTML = `
                <div class="card">
                    <span>Latência média</span>
                    <span class="infoValue" id="initialValue">68 ms</span>
                </div>
                <div class="card">
                    <span>Limite Permitido</span>
                    <span class="infoValue" id="limitValue">100 ms</span>
                </div>
                <div class="card">
                    <span>Quantidade de Alertas</span>
                    <span class="infoValue" id="qtdAlertsValue">6</span>
                    <span onclick="alert('')" id="alertDetails">Ver detalhes</span>
                </div>
            `;

            document.getElementById("alertTimeValue").style.borderColor = 'rgb(102, 35, 168)';
            document.getElementById("totalTimeValue").style.borderColor = 'rgb(102, 35, 168)';
            document.getElementById("geminiText").style.borderColor = 'rgb(102, 35, 168)';
            historicoComponenteEscolhidoChart.options.scales.y.max = 150;
            historicoComponenteEscolhidoChart.options.scales.y.title.text = "Milisegundos";
            historicoComponenteEscolhidoChart.update();

            atualizarGraficoLinha(valores4, maxValues4, 'rgba(102, 35, 168, 0.8)', 'rgba(102, 35, 168, 0.2)', "da Latência");
            document.getElementById("initialValue").innerHTML = `${mediaLatenciaValue} Ms`;
        }
        else {
            document.getElementById("cards").innerHTML = `
                <div class="card">
                    <span>Tráfedo médio</span>
                    <span class="infoValue" id="initialValue">120 Mbps</span>
                </div>
                <div class="card">
                    <span>Limite Permitido</span>
                    <span class="infoValue" id="limitValue">670 Mbps</span>
                </div>
                <div class="card">
                    <span>Quantidade de Alertas</span>
                    <span class="infoValue" id="qtdAlertsValue">2</span>
                    <span onclick="alert('')" id="alertDetails">Ver detalhes</span>
                </div>
            `;
        }
    }

    var dia = 30;
    
    var historicoComponenteEscolhido = document.getElementById('historicoComponenteEscolhido').getContext('2d');
    historicoComponenteEscolhido.canvas.parentNode.style.height = '330px';

    var labels = [];
    var valores1 = [];
    var valores2 = [];
    var valores3 = [];
    var valores4 = [];
    var valores5 = [];

    var maxValues1 = [];
    var maxValues2 = [];
    var maxValues3 = [];
    var maxValues4 = [];
    var maxValues5 = [];

    var valores = [valores1, valores2];

    for(var i = 0; i < dia; i++){
        var data = new Date();
        data.setDate(data.getDate() - (dia - 1 - i));
        labels[i] = data.toLocaleDateString();
        maxValues1[i] = 85;
        maxValues2[i] = 92;
        maxValues3[i] = 94;
        maxValues4[i] = 100;

        valores.forEach((vetorValores)=>{
            if(!i) {
                valores1[i] = Math.random() * 99 + 1;
                valores2[i] = Math.random() * 99 + 1;
            } else {
                if(vetorValores[i - 1] > 95){
                    vetorValores[i] = vetorValores[i - 1] - (Math.random() * 10 + 1 );
                }
                else if(vetorValores[i - 1] < 5) {
                    vetorValores[i] = vetorValores[i - 1] + (Math.random() * 10 + 1)
                }
                else {
                    if(Math.random() < 0.5){
                        vetorValores[i] = vetorValores[i - 1] + (Math.random() * 4 + 1)
                    } else {
                        vetorValores[i] = vetorValores[i - 1] - (Math.random() * 4 + 1)
                    }
                }
            }
        })

        if(!i) valores3[0] = Math.random() * 99 + 1;
        else {
            if(valores3[i - 1] > 95){
                valores3[i] = valores3[i - 1] - (Math.random() * 5 + 1);
            }
            else if(valores3[i - 1] < 5) {
                valores3[i] = valores3[i - 1] + (Math.random() * 5 + 1);
            }
            else {
                valores3[i] = valores3[i - 1] + (Math.random() * 6 - 3);
            }
        }

        if(!i) valores4[0] = Math.random() * 149 + 1;
        else {
            if(valores4[i - 1] > 145){
                valores4[i] = valores4[i - 1] - (Math.random() * 10 + 1);
            }
            else if(valores4[i - 1] < 5) {
                valores4[i] = valores4[i - 1] + (Math.random() * 10 + 1);
            }
            else {
                valores4[i] = valores4[i - 1] + (Math.random() * 10 - 10);
            }
        }
    }

    var mediaCpuUsagePerc = Math.round(valores1.reduce((total, atual) => total + atual, 0) / valores1.length * 10) / 10;
    var mediaRamUsagePerc = Math.round(valores2.reduce((total, atual) => total + atual, 0) / valores2.length * 10) / 10;
    var mediaDiskUsagePerc = Math.round(valores3.reduce((total, atual) => total + atual, 0) / valores3.length * 10) / 10;
    var mediaLatenciaPerc = Math.round(valores4.reduce((total, atual) => total + atual, 0) / valores4.length * 10) / 10;

    var mediaRamUsageValue = Math.round(14.5 * mediaRamUsagePerc / 100 * 10)/10;
    var mediaDiskUsageValue = Math.round(930 * mediaDiskUsagePerc / 100 * 10)/10;
    var mediaLatenciaValue = Math.round(100 * mediaLatenciaPerc / 100 * 10)/10;


    document.getElementById("initialValue").innerHTML = `${mediaCpuUsagePerc}%`;

    var historicoComponenteEscolhidoChart = new Chart(
        historicoComponenteEscolhido,
        {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: "Uso do Processador",
                        borderWidth: 4,
                        borderColor: 'rgba(255, 218, 107, 0.8)',
                        backgroundColor: 'rgba(255, 218, 107, 0.2)',
                        fill: true,
                        lineTension: 0.3,
                        data: valores1
                    },
                    {
                        label: "Máximo",
                        borderWidth: 3,
                        borderColor: 'rgb(200, 0, 0)',
                        data: maxValues1,
                        pointBorderWidth: 0,
                        pointBackgroundColor: 'transparent'
                    }
                ]
            },
            options: {
                scales: {
                    x: {
                        grid: {
                            display: false,
                        },
                        title: {
                            display: true,
                            text: "Dias",
                            color: 'white',
                            font: {
                                size: 16,
                                weight: 'bold',
                            }
                        },
                        ticks: {
                            color: 'white'
                        },
                        border: {
                            color: 'white',
                            width: 1
                        },
                    },
                    y: {
                        border: {
                            color: 'white',
                            width: 1
                        },
                        grid: {
                            color: 'rgba(255, 255, 255, 0.2)',
                            lineWidth: 1
                        },
                        min: 0,
                        max: 100,
                        title: {
                            display: true,
                            text: "Percentual de Uso",
                            color: 'white',
                            font: {
                                size: 16,
                                weight: 'bold'
                            }
                        },
                        ticks: {
                            stepSize: 10,
                            color: 'white'
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        backgroundColor: '#3f3b36'
                    },
                    legend: {
                        labels: {
                            color: 'white',
                            font: {
                                size: 15
                            }
                        },
                        position: 'bottom'
                    },
                    title: {
                        display: true,
                        text: `Últimos Dados Capturados do Uso do Processador`,
                        font: {
                            size: 25,
                            weight: 'bold'
                        },
                        color: 'white'
                    }
                },
                responsive: true
            }
        }
    )

    function atualizarGraficoLinha(vetorValores, vetorMax, cor1, cor2, component){
        historicoComponenteEscolhidoChart.data.datasets[0].data = vetorValores;
        historicoComponenteEscolhidoChart.data.datasets[1].data = vetorMax;
        historicoComponenteEscolhidoChart.data.datasets[0].borderColor = cor1;
        historicoComponenteEscolhidoChart.data.datasets[0].backgroundColor = cor2;
        historicoComponenteEscolhidoChart.data.datasets[0].label = component;
        historicoComponenteEscolhidoChart.options.plugins.title.text = `Últimos Dados Capturados ${component}`;
        historicoComponenteEscolhidoChart.update();
    }

    window.addEventListener("load", () => document.querySelectorAll("#dualHandleSlider").forEach(dualHandleSlider => {
        const input = dualHandleSlider.querySelector("input[type='range']");
        const dayValue = document.getElementById("dayValue");
        
        input.addEventListener("input", () => {
            dayValue.value = input.value;
            dia = input.value;
        })

        dayValue.addEventListener("input", () => {
            input.value = dayValue.value;
            dia = dayValue.value;
        })
    }));

    // var historicoComponenteEscolhido = document.getElementById('historicoComponenteEscolhido').getContext('2d');
    // historicoComponenteEscolhido.canvas.parentNode.style.width = '45%';
    // historicoComponenteEscolhido.canvas.parentNode.style.height = '500px';
</script>
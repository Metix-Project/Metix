<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Métix Proteção Divina</title>
    <link rel="icon" href="../assets/imgs/logo.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.0.2"></script>

    <!-- scripts do Chart.js - 2022-1 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>


    <!--Script Gerador WordCloud -->
    <link rel="shortcut icon" href="../img/icoNumeEtiqueta.ico" type="image/x-icon">

    <script src="../js/script.js"></script>
    <script src="../js/sessao.js"></script>
    <link rel="stylesheet" href="../css/dashboardBase.css">
    <link rel="stylesheet" href="../css/telaHistorico.css">

    <style>
        canvas {
            -moz-user-select: none;
            -webkit-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="profile">
                <img alt="Profile" id="profileImage">
                <h2 id="profileName">Usuário</h2>
                <h4 id="profilePosition">Cargo: Gerente</h4>
                <h4 id="profileBusiness">Banco</h4>
            </div>

            <div class="dashboardLinks">
                <h2>Dashboards</h2>
                <button>Monitoramento</button>
                <button>Alertas</button>
                <button onclick="window.location.href = 'telaHistorico.html'">Histórico</button>
                <button onclick="window.location.href = 'telaPrevisao.html'">Previsões</button>
                <button>Manutenção</button>
                <button onclick="limparSessao()">Sair</button>
            </div>
            <div class="logo">
                <img src="../assets/imgs/Logo1.png" alt="Metix Logo">
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <h1 id="bodyTitle">Histórico dos Dados do Servidor - MacAddress 10f60a853491</h1>
            <div class="graphics1">
                <div class="filtros">
                    <div class="filtro selects">
                        <span>Selecione o Servidor: </span>
                        <select id="selectServer"
                            onchange="atualizarGraficoLinha(
                                    dataVar, 
                                    document.getElementById('selectServer').value, 
                                    document.getElementById('selectHardware').value
                                ), 
                                modificarServidor(document.getElementById('selectServer').value)"
                            >
                            <option>f946307321c2</option>
                            <option>14857f833746</option>
                            <option>d09466c9be45</option>
                            <option>c7d12465a943</option>
                        </select>
                    </div>
                    <div class="filtro selects">
                        <span>Selecione a Métrica: </span>
                        <select id="selectHardware"
                            onchange="atualizarGraficoLinha(
                                dataVar, 
                                document.getElementById('selectServer').value, 
                                document.getElementById('selectHardware').value
                            )">
                            <option value="1">Uso do Processador</option>
                            <option value="2">Uso da Memória RAM</option>
                            <option value="3">Uso do Disco Rígido</option>
                            <option value="4">Latência</option>
                            <option value="5">Velocidade de Rede</option>
                        </select>
                    </div>
                    <div class="filtro" id="dualHandleSlider">
                        <input type="range" min="7" max="91" value="35" step="7">
                        <span class="rangeLegend">
                            Últimos
                            <input type="number" min="7" max="90" value="35" id="dayValue" disabled="true">
                            dias
                        </span>
                    </div>
                </div>
                <div class="metricas">
                    <div class="cards" id="cards">
                        <div class="card">
                            <span>Uso médio da CPU</span>
                            <span class="infoValue" id="initialValue">55%</span>
                        </div>
                        <div class="card">
                            <span>Limite Permitido</span>
                            <span class="infoValue" id="limitValue">85%</span>
                        </div>
                        <div class="card">
                            <span>Quantidade de Alertas</span>
                            <span class="infoValue" id="qtdAlertsValue">4</span>
                            <span onclick="alert('')" id="alertDetails">Ver detalhes</span>
                        </div>
                    </div>
                    <div class="dados">
                        <canvas id="historicoComponenteEscolhido"></canvas>
                        <div class="moreInfo">
                            <div class="warnings">
                                <div class="infoCard">
                                    <span class="title">Tempo Total Acima do Limite Indicado</span>
                                    <span class="cardValue" id="totalTimeValue">3h 45min 54s</span>
                                </div>
                                <div class="infoCard">
                                    <span class="title">Último Registro de Alerta do Componente</span>
                                    <span class="cardValue" id="alertTimeValue">13h24 17/11/2024</span>
                                </div>
                            </div>
                            <div class="infoCard">
                                <span class="title">Sugestão do Gemini</span>
                                <span class="cardValue" id="geminiText">Fazer Upgrade!</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>

</html>

<script>
    window.onload = validarSessao();

    function modificarServidor(macAddress) {
        document.getElementById("bodyTitle").innerHTML = `Histórico dos Dados do Servidor - MacAddress ${macAddress}`;
    }

    function modificarComponente(componente) {
        if (componente == 1) {
            
        }
        else if (componente == 2) {
        }
        else if (componente == 3) {
        }
        else if (componente == 4) {
            document.getElementById("cards").innerHTML = `
                <div class="card">
                    <span>Latência média</span>
                    <span class="infoValue" id="initialValue">68 ms</span>
                </div>
                <div class="card">
                    <span>Limite Permitido</span>
                    <span class="infoValue" id="limitValue">100 ms</span>
                </div>
                <div class="card">
                    <span>Quantidade de Alertas</span>
                    <span class="infoValue" id="qtdAlertsValue">6</span>
                    <span onclick="alert('')" id="alertDetails">Ver detalhes</span>
                </div>
            `;

            document.getElementById("alertTimeValue").style.borderColor = 'rgb(102, 35, 168)';
            document.getElementById("totalTimeValue").style.borderColor = 'rgb(102, 35, 168)';
            document.getElementById("geminiText").style.borderColor = 'rgb(102, 35, 168)';
            historicoComponenteEscolhidoChart.options.scales.y.max = 150;
            historicoComponenteEscolhidoChart.options.scales.y.title.text = "Milisegundos";
            historicoComponenteEscolhidoChart.data.datasets.splice(2, 1);
            historicoComponenteEscolhidoChart.update();

            atualizarGraficoLinha(valores4, maxValues4, 'rgba(102, 35, 168, 0.8)', 'rgba(102, 35, 168, 0.2)', "Latência");
            document.getElementById("initialValue").innerHTML = `${mediaLatenciaValue} Ms`;
        }
        else {
            document.getElementById("cards").innerHTML = `
                <div class="card">
                    <span>Quantidade Média de Pacotes Recebidos</span>
                    <span class="infoValue" id="initialValue">120 Mbps</span>
                </div>
                <div class="card">
                    <span>Quantidade Média de Pacotes Enviados</span>
                    <span class="infoValue" id="limitValue">670 Mbps</span>
                </div>
                <div class="card">
                    <span>Quantidade de Alertas</span>
                    <span class="infoValue" id="qtdAlertsValue">2</span>
                    <span onclick="alert('')" id="alertDetails">Ver detalhes</span>
                </div>
            `;

            document.getElementById("alertTimeValue").style.borderColor = 'rgb(65, 178, 141)';
            document.getElementById("totalTimeValue").style.borderColor = 'rgb(65, 178, 141)';
            document.getElementById("geminiText").style.borderColor = 'rgb(65, 178, 141)';
            historicoComponenteEscolhidoChart.options.scales.y.max = 1250;
            historicoComponenteEscolhidoChart.options.scales.y.title.text = "Mbps";
            historicoComponenteEscolhidoChart.data.datasets[2] = {
                label: "Pacotes Recebidos",
                borderWidth: 4,
                borderColor: 'rgba(5, 208, 222, 0.8)',
                backgroundColor: 'rgba(5, 208, 222, 0.2)',
                fill: true,
                lineTension: 0.3,
                data: valores6
            }
            historicoComponenteEscolhidoChart.update();

            atualizarGraficoLinha(valores5, maxValues5, 'rgba(125, 148, 60, 0.8)', 'rgba(125, 148, 60, 0.2)', "Rede");
            document.getElementById("initialValue").innerHTML = `${mediaLatenciaValue} Ms`;
        }
    }

    var historicoComponenteEscolhido = document.getElementById('historicoComponenteEscolhido').getContext('2d');
    historicoComponenteEscolhido.canvas.parentNode.style.height = '330px';

    var dataAtual = new Date();
    let dia = 35;

    dataAtual.setDate(dataAtual.getDate() - dia);
    let year = dataAtual.getFullYear();
    let month = String(dataAtual.getMonth() + 1).padStart(2, '0');
    let day = String(dataAtual.getDate()).padStart(2, '0');

    let dataVar = `${year}-${month}-${day}`;
    let macAddressVar = "f946307321c2";

    // var valores = [valores1, valores2];
    // var redeValores = [valores5, valores6];

    // var mediaCpuUsagePerc = Math.round(valores1.reduce((total, atual) => total + atual, 0) / valores1.length * 10) / 10;

    // document.getElementById("initialValue").innerHTML = `${mediaCpuUsagePerc}%`;

    //vetorValores, vetorMax, cor1, cor2, component
    function atualizarGraficoLinha(valorData, valorMacAddress, idMetrica) {
        fetch("../historico/pegarMedias", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                dataServer: valorData,
                macAddressServer: valorMacAddress
            })
        })
        .then(function (resposta) {
            console.log(resposta);

            if (resposta.ok) {
                resposta.json().then((dataJsonFunc) => {
                    historicoComponenteEscolhidoChart.data.labels = [];
                    historicoComponenteEscolhidoChart.data.datasets[0].data = [];
                    historicoComponenteEscolhidoChart.data.datasets[1].data = [];
                    historicoComponenteEscolhidoChart.update();

                    var maxData = [];
                    var arrayDate = dataJsonFunc.reverse().map(item => {
                        var dataLocal = new Date(item.dia.split("T")[0]);
                        
                        var diaLocal = ("0" + dataLocal.getDate()).slice(-2);
                        var mesLocal = ("0" + (dataLocal.getMonth() + 1)).slice(-2);
                        var anoLocal = dataLocal.getFullYear();

                        return `${diaLocal}/${mesLocal}/${anoLocal}`;
                    })

                    if(idMetrica == 1){
                        let somaGeralCpu = dataJsonFunc.reduce((acumulador, valor) => acumulador + parseFloat(valor.cpuPorc), 0);
                        let mediaGeralCpu = somaGeralCpu / dataJsonFunc.length;

                        document.getElementById("cards").innerHTML = `
                            <div class="card">
                                <span>Uso médio do Processador</span>
                                <span class="infoValue" id="initialValue">${mediaGeralCpu.toFixed(1)}%</span>
                            </div>
                            <div class="card">
                                <span>Limite Permitido</span>
                                <span class="infoValue" id="limitValue">85%</span>
                            </div>
                            <div class="card">
                                <span>Quantidade de Alertas</span>
                                <span class="infoValue" id="qtdAlertsValue">4</span>
                                <span onclick="alert('')" id="alertDetails">Ver detalhes</span>
                            </div>
                        `;

                        for(var i = 0; i < dataJsonFunc.length; i++){
                            maxData.push(85);
                        }

                        var arrayValues = dataJsonFunc.reverse().map(item => parseFloat(item.cpuPorc));

                        document.getElementById("alertTimeValue").style.borderColor = 'rgb(255, 218, 107)';
                        document.getElementById("totalTimeValue").style.borderColor = 'rgb(255, 218, 107)';
                        document.getElementById("geminiText").style.borderColor = 'rgb(255, 218, 107)';
                        
                        historicoComponenteEscolhidoChart.data.datasets[0].data = arrayValues;
                        historicoComponenteEscolhidoChart.data.datasets[0].label = "Uso do Processador";
                        historicoComponenteEscolhidoChart.data.datasets[0].borderColor = 'rgba(255, 218, 107, 0.8)';
                        historicoComponenteEscolhidoChart.data.datasets[0].backgroundColor = 'rgba(255, 218, 107, 0.2)';
                        historicoComponenteEscolhidoChart.data.datasets[1].data = maxData;
                        historicoComponenteEscolhidoChart.data.labels = arrayDate;
                        historicoComponenteEscolhidoChart.options.plugins.title.text = `Últimos Dados Capturados | Uso do Processador`;
                        historicoComponenteEscolhidoChart.options.scales.y.max = 100;
                        historicoComponenteEscolhidoChart.options.scales.y.title.text = "Percentual de Uso";
                        historicoComponenteEscolhidoChart.data.datasets.splice(2, 1);
                    }
                    else if(idMetrica == 2){
                        let somaGeralRam = dataJsonFunc.reduce((acumulador, valor) => acumulador + parseFloat(valor.memoriaGb), 0);
                        let mediaGeralRam = somaGeralRam / dataJsonFunc.length;

                        let somaGeralTotalRam = dataJsonFunc.reduce((acumulador, valor) => acumulador + parseFloat(valor.memoriaTotal), 0);
                        let mediaGeralTotalRam = somaGeralTotalRam / dataJsonFunc.length;

                        document.getElementById("cards").innerHTML = `
                            <div class="card">
                                <span>Uso médio da Memória RAM</span>
                                <span class="infoValue" id="initialValue">${mediaGeralRam.toFixed(1)} GB</span>
                            </div>
                            <div class="card">
                                <span>Limite Permitido</span>
                                <span class="infoValue" id="limitValue">14.5 GB</span>
                            </div>
                            <div class="card">
                                <span>Total de Memória RAM</span>
                                <span class="infoValue" id="initialValue">${mediaGeralTotalRam.toFixed(1)} GB</span>
                            </div>
                            <div class="card">
                                <span>Quantidade de Alertas</span>
                                <span class="infoValue" id="qtdAlertsValue">2</span>
                                <span onclick="alert('')" id="alertDetails">Ver detalhes</span>
                            </div>
                        `;

                        for(var i = 0; i < dataJsonFunc.length; i++){
                            maxData.push(85);
                        }

                        var arrayValues = dataJsonFunc.reverse().map(item => parseFloat(item.memoriaPorc));

                        document.getElementById("alertTimeValue").style.borderColor = 'rgb(192, 178, 160)';
                        document.getElementById("totalTimeValue").style.borderColor = 'rgb(192, 178, 160)';
                        document.getElementById("geminiText").style.borderColor = 'rgb(192, 178, 160)';

                        historicoComponenteEscolhidoChart.data.datasets[0].data = arrayValues;
                        historicoComponenteEscolhidoChart.data.datasets[0].label = "Uso da Memória RAM";
                        historicoComponenteEscolhidoChart.data.datasets[0].borderColor = 'rgba(192, 178, 160, 0.8)';
                        historicoComponenteEscolhidoChart.data.datasets[0].backgroundColor = 'rgba(192, 178, 160, 0.2)';
                        historicoComponenteEscolhidoChart.data.datasets[1].data = maxData;
                        historicoComponenteEscolhidoChart.data.labels = arrayDate;
                        historicoComponenteEscolhidoChart.options.plugins.title.text = `Últimos Dados Capturados | Uso da Memória RAM`;
                        historicoComponenteEscolhidoChart.options.scales.y.max = 100;
                        historicoComponenteEscolhidoChart.options.scales.y.title.text = "Percentual de Uso";
                        historicoComponenteEscolhidoChart.data.datasets.splice(2, 1);
                    }
                    else if(idMetrica == 3){
                        let somaGeralDisco = dataJsonFunc.reduce((acumulador, valor) => acumulador + parseFloat(valor.discoGb), 0);
                        let mediaGeralDisco = somaGeralDisco / dataJsonFunc.length;

                        let somaGeralTotalDisco = dataJsonFunc.reduce((acumulador, valor) => acumulador + parseFloat(valor.discoTotal), 0);
                        let mediaGeralTotalDisco = somaGeralTotalDisco / dataJsonFunc.length;

                        document.getElementById("cards").innerHTML = `
                            <div class="card">
                                <span>Média do Armazenamento</span>
                                <span class="infoValue" id="initialValue">${mediaGeralDisco.toFixed(1)} GB</span>
                            </div>
                            <div class="card">
                                <span>Limite Permitido</span>
                                <span class="infoValue" id="limitValue">930 GB</span>
                            </div>
                            <div class="card">
                                <span>Armazenamento Total</span>
                                <span class="infoValue" id="initialValue">${mediaGeralTotalDisco.toFixed(1)} GB</span>
                            </div>
                            <div class="card">
                                <span>Quantidade de Alertas</span>
                                <span class="infoValue" id="qtdAlertsValue">0</span>
                                <span onclick="alert('')" id="alertDetails">Ver detalhes</span>
                            </div>
                        `;

                        for(var i = 0; i < dataJsonFunc.length; i++){
                            maxData.push(90);
                        }

                        var arrayValues = dataJsonFunc.reverse().map(item => parseFloat(item.discoPorc));

                        document.getElementById("alertTimeValue").style.borderColor = 'rgb(249, 146, 44)';
                        document.getElementById("totalTimeValue").style.borderColor = 'rgb(249, 146, 44)';
                        document.getElementById("geminiText").style.borderColor = 'rgb(249, 146, 44)';

                        historicoComponenteEscolhidoChart.data.datasets[0].data = arrayValues;
                        historicoComponenteEscolhidoChart.data.datasets[0].label = "Armazenamento do Disco";
                        historicoComponenteEscolhidoChart.data.datasets[0].borderColor = 'rgba(249, 146, 44, 0.8)';
                        historicoComponenteEscolhidoChart.data.datasets[0].backgroundColor = 'rgba(249, 146, 44, 0.2)';
                        historicoComponenteEscolhidoChart.data.datasets[1].data = maxData;
                        historicoComponenteEscolhidoChart.data.labels = arrayDate;
                        historicoComponenteEscolhidoChart.options.plugins.title.text = `Últimos Dados Capturados | Armazenamento do Disco`;
                        historicoComponenteEscolhidoChart.options.scales.y.max = 100;
                        historicoComponenteEscolhidoChart.options.scales.y.title.text = "Percentual de Uso";
                        historicoComponenteEscolhidoChart.data.datasets.splice(2, 1);
                    }
                    else if(idMetrica == 4){
                        let somaGeralLatencia = dataJsonFunc.reduce((acumulador, valor) => acumulador + parseFloat(valor.latencia), 0);
                        let mediaGeralLatencia = somaGeralLatencia / dataJsonFunc.length;
                        
                        document.getElementById("cards").innerHTML = `
                            <div class="card">
                                <span>Latência média</span>
                                <span class="infoValue" id="initialValue">${mediaGeralLatencia.toFixed(1)} ms</span>
                            </div>
                            <div class="card">
                                <span>Limite Permitido</span>
                                <span class="infoValue" id="limitValue">100 ms</span>
                            </div>
                            <div class="card">
                                <span>Quantidade de Alertas</span>
                                <span class="infoValue" id="qtdAlertsValue">6</span>
                                <span onclick="alert('')" id="alertDetails">Ver detalhes</span>
                            </div>
                        `;

                        for(var i = 0; i < dataJsonFunc.length; i++){
                            maxData.push(100);
                        }

                        var arrayValues = dataJsonFunc.reverse().map(item => parseFloat(item.latencia));

                        document.getElementById("alertTimeValue").style.borderColor = 'rgb(102, 35, 168)';
                        document.getElementById("totalTimeValue").style.borderColor = 'rgb(102, 35, 168)';
                        document.getElementById("geminiText").style.borderColor = 'rgb(102, 35, 168)';

                        historicoComponenteEscolhidoChart.data.datasets[0].data = arrayValues;
                        historicoComponenteEscolhidoChart.data.datasets[0].label = "Latência";
                        historicoComponenteEscolhidoChart.data.datasets[0].borderColor = 'rgba(102, 35, 168, 0.8)';
                        historicoComponenteEscolhidoChart.data.datasets[0].backgroundColor = 'rgba(102, 35, 168, 0.2)';
                        historicoComponenteEscolhidoChart.data.datasets[1].data = maxData;
                        historicoComponenteEscolhidoChart.data.labels = arrayDate;
                        historicoComponenteEscolhidoChart.options.plugins.title.text = `Últimos Dados Capturados | Latência`;
                        historicoComponenteEscolhidoChart.options.scales.y.max = 250;
                        historicoComponenteEscolhidoChart.options.scales.y.title.text = "Percentual de Uso";
                        historicoComponenteEscolhidoChart.data.datasets.splice(2, 1);
                    }
                    else {

                    }

                    historicoComponenteEscolhidoChart.update();
                })
            } else throw "Erro";
        })
        .catch(function (erro) {
            console.error(erro);
        })

        // historicoComponenteEscolhidoChart.data.datasets[0].data = vetorValores;
        // historicoComponenteEscolhidoChart.data.datasets[1].data = vetorMax;
        // historicoComponenteEscolhidoChart.data.datasets[0].borderColor = cor1;
        // historicoComponenteEscolhidoChart.data.datasets[0].backgroundColor = cor2;
        // historicoComponenteEscolhidoChart.data.datasets[0].label = component;
        // historicoComponenteEscolhidoChart.options.plugins.title.text = `Últimos Dados Capturados | ${component}`;
        // historicoComponenteEscolhidoChart.update();
    }

    window.addEventListener("load", () => document.querySelectorAll("#dualHandleSlider").forEach(dualHandleSlider => {
        const input = dualHandleSlider.querySelector("input[type='range']");
        const dayValue = document.getElementById("dayValue");

        input.addEventListener("mouseup", () => {
            dayValue.value = input.value;
            dia = input.value;

            var dataAtual = new Date();
            dataAtual.setDate(dataAtual.getDate() - dia);
            year = dataAtual.getFullYear();
            month = String(dataAtual.getMonth() + 1).padStart(2, '0');
            day = String(dataAtual.getDate()).padStart(2, '0');

            dataVar = `${year}-${month}-${day}`;

            atualizarGraficoLinha(dataVar, macAddressVar, document.getElementById("selectHardware").value);
        })
    }));

    var historicoComponenteEscolhidoChart = new Chart(
        historicoComponenteEscolhido,
        {
            type: 'line',
            data: { 
                datasets: [
                    {
                        label: "",
                        borderWidth: 4,
                        borderColor: 'rgba(255, 218, 107, 0.8)',
                        backgroundColor: 'rgba(255, 218, 107, 0.2)',
                        fill: true,
                        lineTension: 0.3
                    },
                    {
                        label: "Máximo",
                        borderWidth: 3,
                        borderColor: 'rgb(200, 0, 0)',
                        pointBorderWidth: 0,
                        pointBackgroundColor: 'transparent'
                    }
                ]
            },
            options: {
                scales: {
                    x: {
                        grid: {
                            display: false,
                        },
                        title: {
                            display: true,
                            text: "Dias",
                            color: 'white',
                            font: {
                                size: 16,
                                weight: 'bold',
                            }
                        },
                        ticks: {
                            color: 'white'
                        },
                        border: {
                            color: 'white',
                            width: 1
                        },
                    },
                    y: {
                        border: {
                            color: 'white',
                            width: 1
                        },
                        grid: {
                            color: 'rgba(255, 255, 255, 0.2)',
                            lineWidth: 1
                        },
                        min: 0,
                        max: 100,
                        title: {
                            display: true,
                            text: "Percentual de Uso",
                            color: 'white',
                            font: {
                                size: 16,
                                weight: 'bold'
                            }
                        },
                        ticks: {
                            stepSize: 10,
                            color: 'white'
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        backgroundColor: '#3f3b36'
                    },
                    legend: {
                        labels: {
                            color: 'white',
                            font: {
                                size: 15
                            }
                        },
                        position: 'bottom'
                    },
                    title: {
                        display: true,
                        text: `Últimos Dados Capturados | Uso do Processador`,
                        font: {
                            size: 25,
                            weight: 'bold'
                        },
                        color: 'white'
                    }
                },
                responsive: true
            }
        }
    )

    atualizarGraficoLinha(dataVar, macAddressVar, 1);
</script>
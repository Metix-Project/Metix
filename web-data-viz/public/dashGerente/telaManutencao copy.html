<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - Métix Proteção Divina</title>
  <link rel="icon" href="../assets/imgs/logo.png">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="../css/telaManutencao.css">
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="../js/sessao.js"></script>
  <link rel="stylesheet" href="../css/dashboardBase.css">
</head>

<body>
  <div class="container">

<!-- Sidebar -->
<div class="sidebar">
  <div class="profile">
    <img alt="Profile" id="profileImage">
    <h2 id="profileName">Usuário</h2>
    <h4 id="profilePosition">Cargo: Gerente</h4>
    <h4 id="profileBusiness">Banco</h4>
  </div>

  <div class="dashboardLinks">
    <h2>Dashboards</h2>
    <button>Monitoramento</button>
    <button>Alertas</button>
    <button onclick="window.location.href = 'telaHistorico.html'">Histórico</button>
    <button>Previsões</button>
    <button>Manutenção</button>
    <button onclick="limparSessao()">Sair</button>
  </div>
  <div class="logo">
    <img src="../assets/imgs/Logo1.png" alt="Metix Logo">
  </div>
</div>


    <div class="main-content">
      <div class="content-wrapper">
        <div id="calendar-navigation">
          <button id="prev-month" style="display: none;">← Mês Anterior</button>
          <button id="next-month" onclick="goToNextMonth()">Próximo Mês &rarr;</button>
        </div>
        <div id="calendar-container">
        </div>
      </div>

      <div class="side-form">
        <form id="schedule-form">
          <label for="schedule-date">Data:</label>
          <input type="date" id="schedule-date" name="schedule-date" required>
          
          <label for="schedule-time">Hora:</label>
          <input type="time" id="schedule-time" name="schedule-time" required>
          
          <label for="server-select">Servidor:</label>
          <select id="server-select" name="server-select" required>
            <option value="" disabled selected>Selecione um servidor</option>
            <option value="server1">Servidor 1</option>
            <option value="server2">Servidor 2</option>
            <option value="server3">Servidor 3</option>
            <option value="server4">Servidor 4</option>

          </select>
          
          <label for="component-select">Componente:</label>
          <select id="component-select" name="component-select" required>
            <option value="" disabled selected>Selecione um componente</option>
            <option value="cpu">CPU</option>
            <option value="ram">RAM</option>
            <option value="disk">DISCO</option>
          </select>
          
          <button id="schedule-button">Agendar</button>
        </form>
        
      </div>

    </div>



  

 
</body>
</html>

<script>
 let currentMonthIndex = 0; // Variável para rastrear o índice do mês atual

const fetchData = async () => {
  try {
    const response = await fetch("https://3x712yec1c.execute-api.us-east-1.amazonaws.com/Curated-JSON-HTML-prev2");
    const rawData = await response.json();

    // Agrupando transações por mês e dia
    const groupedData = rawData.reduce((acc, curr) => {
      const monthKey = `${curr.ano}-${curr.mes}`;
      acc[monthKey] = acc[monthKey] || [];
      acc[monthKey].push(curr);
      return acc;
    }, {});

    // Transformamos os dados para serem acessíveis por mês
    return Object.entries(groupedData).map(([key, values]) => {
      const [ano, mes] = key.split("-").map(Number);
      const dailyTotals = values.reduce((dayAcc, curr) => {
        const dateKey = curr.dia;
        dayAcc[dateKey] = (dayAcc[dateKey] || 0) + curr.media_transacoes_hora;
        return dayAcc;
      }, {});

      return {
        ano,
        mes,
        dailyTotals,
      };
    });
  } catch (error) {
    console.error("Erro ao buscar dados:", error);
    return [];
  }
};

const renderCalendar = async (monthIndex = 0) => {
  const data = await fetchData();

  if (data.length === 0) {
    console.error("Nenhum dado disponível para renderizar o calendário.");
    return;
  }

  const { ano, mes, dailyTotals } = data[monthIndex];
  const maxTransactions = Math.max(...Object.values(dailyTotals));
  const colorScale = d3.scaleLinear().domain([0, maxTransactions]).range(["#ffffff", "#d7301f"]);

  const container = d3.select("#calendar-container");
  container.html("");

  const monthTitle = new Date(ano, mes - 1).toLocaleString("pt-BR", { month: "long", year: "numeric" });
  container.append("h2").attr("class", "month-title").text(monthTitle);

  const weekDays = ["Su", "Mo", "Tu", "We", "Th", "Fr", "Sa"];
  const header = container.append("div").attr("class", "calendar-header");
  weekDays.forEach((day) => {
    header.append("div").attr("class", "day-label").text(day);
  });

  const daysInMonth = new Date(ano, mes, 0).getDate();
  const startDay = new Date(ano, mes - 1, 1).getDay();

  const grid = container.append("div").attr("class", "calendar-grid");

  for (let i = 0; i < startDay; i++) {
    grid.append("div").attr("class", "day-cell empty");
  }

  for (let day = 1; day <= daysInMonth; day++) {
    const total = dailyTotals[day] || 0;
    grid
      .append("div")
      .attr("class", "day-cell")
      .style("background-color", colorScale(total))
      .text(day)
      .on("click", () => displayHourlyTransactions(day, ano, mes)); // Adiciona evento de clique
  }
};


const updateNavigationButtons = (currentIndex, dataLength) => {
  const nextButton = document.getElementById("next-month");

  if (currentIndex < dataLength - 1) {
    nextButton.textContent = "Próximo Mês →";
  } else if (currentIndex > 0) {
    nextButton.textContent = "← Mês Anterior";
  } else {
    nextButton.textContent = "Navegação indisponível"; // Caso esteja no limite sem mais meses.
  }
};

document.getElementById("next-month").addEventListener("click", async () => {
  const data = await fetchData();

  if (currentMonthIndex < data.length - 1) {
    currentMonthIndex++;
  } else if (currentMonthIndex > 0) {
    currentMonthIndex--;
  }

  renderCalendar(currentMonthIndex);
  updateNavigationButtons(currentMonthIndex, data.length);
});

// Inicializa o calendário
(async () => {
  const data = await fetchData();
  renderCalendar(currentMonthIndex);
  updateNavigationButtons(currentMonthIndex, data.length);
})();


    </script>
<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - Métix Proteção Divina</title>
  <link rel="icon" href="../assets/imgs/logo.png">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="../js/sessao.js"></script>
  <script src="https://unpkg.com/cal-heatmap/dist/cal-heatmap.min.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/cal-heatmap/dist/cal-heatmap.css">
  <script src="https://unpkg.com/@popperjs/core@2"></script>
  <script src="https://unpkg.com/cal-heatmap/dist/plugins/Tooltip.min.js"></script>
  <script src="https://unpkg.com/cal-heatmap/dist/plugins/LegendLite.min.js"></script>
  <script src="https://unpkg.com/cal-heatmap/dist/plugins/CalendarLabel.min.js"></script>
  <link rel="stylesheet" href="../css/dashboardBase.css">
</head>

<body>
  <div class="container">
    <!-- Sidebar -->
    <div class="sidebar">
      <div class="profile">
        <img alt="Profile" id="profileImage">
        <h2 id="profileName">Usuário</h2>
        <h4 id="profilePosition">Cargo: Gerente</h4>
        <h4 id="profileBusiness">Banco</h4>
      </div>

      <div class="dashboardLinks">
        <h2>Dashboards</h2>
        <button>Monitoramento</button>
        <button>Alertas</button>
        <button onclick="window.location.href = 'telaHistorico.html'">Histórico</button>
        <button>Previsões</button>
        <button>Manutenção</button>
        <button onclick="limparSessao()">Sair</button>
      </div>
      <div class="logo">
        <img src="../assets/imgs/Logo1.png" alt="Metix Logo">
      </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <h1 id="bodyTitle">DASHBOARD DE MANUTENÇÃO</h1>
      <div id="cal-heatmap"></div>
      <div id="heatmap-container"
        style="background: #22272d; color: #adbac7; border-radius: 3px; padding: 1rem; overflow: hidden;">
        <div id="ex-ghDay" class="margin-bottom--md"></div>
        <a id="previous" href="#" class="button button--sm button--secondary margin-top--sm" style="margin-right: 8px;">
          ← Previous
        </a>
        <a id="next" href="#" class="button button--sm button--secondary margin-top--sm">
          Next →
        </a>
        <div style="float: right; font-size: 12px;">
          <span style="color: #768390;">Less</span>
          <div id="ex-ghDay-legend" style="display: inline-block; margin: 0 4px;"></div>
          <span style="color: #768390; font-size: 12px;">More</span>
        </div>
      </div>

      <!-- Summary Cards -->
      <button onclick="agendarManutencao()">Agendar manutenção</button>
      <div id="formularioAgendamento">
        <h3>Agendamento de Manutenção</h3>
        <form>
          <label for="data">Data:</label>
          <input type="date" id="data" name="data" required><br><br>

          <label for="hora">Hora:</label>
          <input type="time" id="hora" name="hora" required><br><br>

          <label for="servidor">Servidor:</label>
          <input type="number" id="servidor" name="servidor" min="1" max="4" required><br><br>

          <label for="descricao">Componente:</label>
          <textarea id="descricao" name="descricao" required></textarea><br><br>

          <button type="submit">CONFIRMAR</button>
        </form>
      </div>
    </div>
  </div>
</body>

</html>

<script>

  // Função para exibir o formulário
  function agendarManutencao() {
    const formulario = document.getElementById('formularioAgendamento');
    formulario.style.display = 'block'; // Exibe o formulário
  }

  // CAL HEAT MAP
  fetch("https://3x712yec1c.execute-api.us-east-1.amazonaws.com/Curated-JSON-HTML-prev2")
    .then((response) => response.json())
    .then((data) => {
      console.log("Dados carregados:", data);

      // Filtrar para incluir apenas os dois primeiros meses (Dezembro/2024 e Janeiro/2025)
      const startDate = new Date(2024, 11, 1); // Dezembro de 2024
      const endDate = new Date(2025, 1, 1); // Janeiro de 2025

      const filteredData = data.filter((entry) => {
        const entryDate = new Date(entry.ano, entry.mes - 1, entry.dia); // Ajusta o mês
        return entryDate >= startDate && entryDate < endDate;
      });

      // Agrupando transações por dia
      const dailyTransactions = {};
      filteredData.forEach((entry) => {
        const dayKey = `${entry.ano}-${entry.mes}-${entry.dia}`;
        dailyTransactions[dayKey] = (dailyTransactions[dayKey] || 0) + entry.media_transacoes_hora;
      });

      // Transformando os dados no formato exigido pelo CalHeatmap
      const calData = Object.entries(dailyTransactions).map(([key, value]) => ({
        date: new Date(...key.split("-").map((v, i) => (i === 1 ? v - 1 : v))), // Converte chave em data
        value,
      }));

      // Determinando o mínimo e o máximo de transações diárias
      const transactionValues = Object.values(dailyTransactions);
      const minTransactions = Math.min(...transactionValues);
      const maxTransactions = Math.max(...transactionValues);

      console.log("Min Transações:", minTransactions, "Max Transações:", maxTransactions);

      // Definindo o domínio para escala de cores
      const rangeStep = maxTransactions > minTransactions
        ? (maxTransactions - minTransactions) / 4
        : 1; // Evita divisão por 0 ou valores inválidos
      const domain = [
        minTransactions,
        minTransactions + rangeStep,
        minTransactions + 2 * rangeStep,
        maxTransactions,
      ];

      // Configurando o CalHeatmap
      const cal = new CalHeatmap();

      cal.paint({
        data: {
          source: calData,
          x: (d) => d.date, // Data calculada
          y: (d) => d.value, // Soma total de transações por dia
        },
        date: {
          start: startDate, // Início do calendário
          range: 2, // Exibe dois meses no calendário
        },
        domain: {
          type: "month",
          gutter: 4,
          label: {
            text: "MMM", // Nome do mês
            textAlign: "start",
            position: "top",
          },
        },
        subDomain: {
          type: "day", // Células representando dias
          radius: 2,
          width: 11,
          height: 11,
          gutter: 4,
        },
        scale: {
          color: {
            type: "threshold",
            range: ["#fee8c8", "#fdbb84", "#fc8d59", "#d7301f"], // Escala de cores
            domain: domain, // Baseado no mínimo e máximo de transações
          },
        },
      }, [
        [
          Tooltip,
          {
            text: (date, value) => {
              const parsedDate = new Date(date);
              return `${value || "Sem"} transações em ${parsedDate.toLocaleDateString("pt-BR")}`;
            },
          },
        ],
        [
          LegendLite,
          {
            includeBlank: true,
            itemSelector: "#ex-ghDay-legend",
            radius: 2,
            width: 11,
            height: 11,
            gutter: 4,
          },
        ],
      ]);
    })
    .catch((error) => console.error("Erro ao carregar os dados:", error));

</script>

<style>
  #formularioAgendamento {
    display: none;
    /* Inicialmente escondido */
    margin-top: 20px;
    padding: 20px;
    border: 2px solid rgb(99, 99, 99);
    ;
    border-radius: 5px;
    background-color: #2C2C2C;
    color: white;
  }

  /* From Uiverse.io by portseif */
  button {
    align-items: center;
    background-color: #2C2C2C;
    color: #fff;
    cursor: pointer;
    display: flex;
    font-family: ui-sans-serif, system-ui, -apple-system, system-ui, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
    font-size: 1rem;
    font-weight: 700;
    line-height: 1.5;
    text-decoration: none;
    text-transform: uppercase;
    outline: 0;
    border: 0;
    padding: 1rem;
    border-radius: 70px 70px 70px 70px;
    border: 2px solid rgb(99, 99, 99);
    ;
  }

  button:before {
    background-color: #fff;
    content: "";
    display: inline-block;
    height: 1px;
    margin-right: 10px;
    transition: all .42s cubic-bezier(.25, .8, .25, 1);
    width: 0;
  }

  button:hover:before {
    background-color: #fff;
    width: 3rem;
  }
</style>